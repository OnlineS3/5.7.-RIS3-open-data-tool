{% extends "base.html" %}
{% load static %}
{% load custom %}

{% block addHead %}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/2.8.0/css/flag-icon.css"/>
	<link rel="stylesheet" href="{% static "css/other.css" %}"/>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

    <style>
    .pagetitle {
        margin: 0;
        color: #de1515;
        padding: 1rem 0 0rem 1rem;
        font-style: normal;
        font-weight: 400;
        clear: both;
        font-size: 21px;
        font-family: tahoma
    }
    </style>
    <script type="application/javascript">
    var bookmarks = [];
    $(document).ready(function() {
        {% for bookmark in bookmarks %}
            $('#bookmarks').append('<li id="{{ bookmark.id }}" class="list-group-item"><a href="?query={{ bookmark.id }}&queryContext=id"><strong> {{ bookmark.acronym }} </strong> <sup> {{ bookmark.frameworkProgramme }} </sup> <br/> {{ bookmark.title }} </a> {# <a onclick="updateBookmark({{ bookmark.id }},\'{{ bookmark.acronym }}\',\'{{ bookmark.title }}\',\'{{ bookmark.frameworkProgramme }}\');"><span class="fa fa-times-circle"/></a> #}</li>');
            $('#bm_{{ bookmark.id }}').removeClass('fa-bookmark-o').addClass('fa-bookmark');
            bookmarks.push({id:{{ bookmark.id }}, acronym:'{{ bookmark.acronym }}', title:'{{ bookmark.title }}', framework:'{{ bookmark.frameworkProgramme }}'});
        {% empty %}
            $('#bookmarks').append('<li id="init" class="list-group-item">No bookmarks to show.<br/>Add bookmarks by clicking (<span class="fa fa-bookmark-o"/>)</li>');
        {% endfor %}
    });
    function updateBookmark(id, acronym, title, framework) {
        var ind = bookmarks.findIndex(function(e){return e.id == id;});
        if(ind!==-1) {
            $('#' + id).remove();
            $('#bm_' + id).removeClass('fa-bookmark').addClass('fa-bookmark-o');
            bookmarks.splice(ind, 1);
            if(jQuery.isEmptyObject(bookmarks))
                $('#bookmarks').append('<li id="init" class="list-group-item">No bookmarks to show.<br/>Add bookmarks by clicking (<span class="fa fa-bookmark-o"/>)</li>');
        } else {
            $('#bookmarks').append('<li id="' + id + '" class="list-group-item"><a href="?query=' + id + '&queryContext=id"><strong>' + acronym + '</strong> <sup>' + framework + '</sup> <br/>' + title + '</a> {# <a onclick="updateBookmark(' + id + ', \'' + acronym + '\', ' + title + ', ' + framework + ');"><span class="fa fa-times-circle"/></a>#} </li>');
            $('#bm_' + id).removeClass('fa-bookmark-o').addClass('fa-bookmark');
            bookmarks.push({id: id, acronym: acronym, title: title, framework: framework});
            if($('#init').length > 0)
                $('#init').remove();
        }
        $.ajax({
            url: "{% url 'bookmarked' %}",
            type: "POST",
            data: JSON.stringify(id),
            contentType: "application/json",
            headers: { "X-CSRFToken": $.cookie("csrftoken") }
        });
    }

    $("#queryContext").val("{{ queryContext }}").change();
    $("#records").val("{{ records }}").change();
    $("#order").val("{{ order }}").change();
    $("#sort").change(function() {
        var $od = $("#order");
        $od.empty();
        var id = $(this).val();
        if (id == '') {
            $od.hide();
        } else {
            if (id == 'Query')
                var op={"A-Z: Ascending": "", "Z-A: Descending": "-"}
            else
                var op={"Earliest First": "", "Latest First": "-"}
            $.each(op, function(k, v) {
                $od.append($("<option></option>").attr("value", v).text(k));
            });
            $od.show();
        }
    });
    $("#sort").val("{{ sort }}").change();

    $('#bookmarks').affix({
        offset: {
            top: 410
        }
    });

    $(document).ready(function() {
        var maxLen = 250;
        var more = "Read more";
        var less = " Show less";
        $('.more').each(function(){
            var content = $(this).html();
            if($.trim(content).length > maxLen){
               var truncated = content.substr(0, maxLen);
               var removed = content.substr(maxLen, $.trim(content).length);
               var html = truncated + '<span class="ellipses">...</span><span class="moreContent"><span>' + removed + '</span><a href="" class="moreLink">' + more + '</a></span>';
               $(this).html(html);
            }
        });
        $(".moreLink").click(function() {
            if($(this).hasClass("less")){
               $(this).removeClass("less");
               $(this).html(more);
            }else{
               $(this).addClass("less");
               $(this).html(less);
            }
            $(this).parent().prev().toggle();   //Toggle ellipses
            $(this).prev().toggle();            //Toggle 'hidden' content
            return false;
        });
    });
    </script>
{% endblock %}

<!-- Application's space -->
{% block content %}
<div class="site-content">

	<article id="main-content">

		<h2 class="pagetitle">RIS3 Open Data Tool</h2>

        <!-- Notifications -->
        {% if query == '' %}
        <h4>Projects and Organisations</h4>
        <p>
            Search and access all of the European Commission's information on the lifecycle of projects via the
            Community Research and Development Information Service (CORDIS): Available information includes grant
            details, funding and participants, the projects' own Report Summaries, the latest multilingual
            Results in Brief and links to specific publications and other documents.
        </p>
        {% endif %}

        <!-- Form: User Input -->
        <form role="form" method="get" action="{% url 'query' %}">
            <br/>
            <h4>Search:</h4>
            <!-- Unrestricted Search -->
            <div class="row">
                <div class="col-xs-12">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control input-lg" name="query" placeholder="Search" value="{{ query }}"/>
                        <div class="input-group-btn">
                            <select class="btn btn-default" name="queryContext" id="queryContext">
                                <option label="Title">title</option>
                                <option label="Acronym">acronym</option>
                                <option label="ID">id</option>
                                <option label="Objective">objective</option>
{#                                <option label="Coordinator">coordinator</option>                                      #}
{#                                <option label="Coordinator Country">coordinatorCountry</option>                       #}
                                <option label="Call">call</option>
                                <option label="Programme">programme</option>
                                <option label="Funding Scheme">fundingScheme</option>
                                <option label="NUTS Region">region</option>
                            </select>
                            <button type="button" class="btn btn-default" data-toggle="collapse" data-target="#filters"><span class="fa fa-filter"/></button>
                            <button type="submit" class="btn btn-default btn-lg" ><span class="glyphicon glyphicon-search"></span></button>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <div id="filters" class="collapse">
                <div>
                    <!-- Filters -->
                    <div class="row" style="float: left">
                       <div class="input-group">
                           Sort By:
                            <select class="btn btn-default btn-xs" name="sort" id="sort">
                                <option value="Query">Query</option>
                                <option value="startDate">Start Date</option>
                                <option value="endDate">End Date</option>
                            </select>
                            <select class="btn btn-default btn-xs" name="order" id="order"></select>
                        </div>
                    </div>
                    <div class="row" style="float: right;">
                       Show:
                        <select class="btn btn-default btn-xs" name="show" id="records">
                            <option>1</option>
                            <option>5</option>
                            <option selected>10</option>
                            <option>20</option>
                            <option>50</option>
                            <option>100</option>
                            <option>All</option>
                        </select>
                        per page
                    </div>
                </div>
            </div>
            <!-- End Filters -->
        </form>
        <!-- End Form -->
        {% if query != "" %}
        <div class="row">
            <h3 style="text-align: center;">{{ query }}</h3>
            <!-- Records -->
            <p style="text-align: center;">
                Records {{ projects.start_index }}-{{ projects.end_index }} of {{ no }}
            </p>
        </div>

        <div class="tab-content">
            <div id="projects" class="tab-pane fade in active">
                <!-- Individual Projects -->
                Result{% if projects|length > 1 %}s{% endif %}:
                {% if queryContext == "id" %}               Project Overview
                {% elif queryContext == 'coordinator' %}    Projects Coordinated
                {% elif queryContext == "fundingScheme" %}  Projects Funded
                {% endif %}                                 <br/>

                {% for project in projects %}
                <div class="panel panel-default">
                    <div class="panel-body media">
                        <div class="media-left">
                            <img src="{%  static "img/H2020.png" %}" alt="H2020" height="52px" width="52px"/>
                        </div>
                        <div class="media-body">
                            <h4 class="media-heading">[PROJECT] <strong>{{ project.acronym }}</strong> - <a href="?{% url_replace query=project.id queryContext="id" %}">{{ project.title }}</a></h4>
                            <strong>ID: </strong>{{ project.id }} <a onclick="updateBookmark('{{ project.id }}', '{{ project.acronym }}', '{{ project.title }}', '{{ project.frameworkProgramme }}')"><span id="bm_{{ project.id }}" class="fa fa-bookmark{% if not project.id in bookmarks %}-o{% endif %}"/></a><br/>
                            <strong>Website: </strong>{% if not project.projectUrl|is_nan %}<a href="http://{{ project.projectUrl }}">{{ project.projectUrl }} <span class="fa fa-external-link"/></a>{% else %}N/A{% endif %}<br/>
                            <strong>Start date: </strong>{{ project.startDate }}, <strong>End date: </strong>{{ project.endDate }}<br/>
                            <strong>Status: </strong>{{ project.status|title }} {% if project.status == 'SIGNED' %}<span class="fa fa-handshake-o"></span>{% elif project.status == 'TERMINATED' %}<span class="fa fa-ban"></span>{% endif %}<br/>
                            <strong>Objective: </strong>{% if queryContext != 'id' %}<span class="more">{{ project.objective }}</span>{% else %}{{ project.objective }}{% endif %}<br/>
                            <strong>Call: </strong><a href="?{% url_replace query=project.call queryContext="call" %}">{{ project.call }}</a><br/>
                            <strong>Programme: </strong>
                            {% for p in project.programme|split %}
                            <a href="?{% url_replace query=p queryContext="programme" %}">{{ p }}</a>
                            {% endfor %}<br/>
                            <strong>Funding: </strong><a href="?{% url_replace query=project.fundingScheme queryContext="fundingScheme" %}">{{ project.fundingScheme }}</a>
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if queryContext == 'id' or queryContext == 'coordinator' %}
                <h4>More Info:</h4>
                <ul class="nav nav-tabs">
                    {% if queryContext == 'id' %}<li class="active"><a data-toggle="tab" href="#Consortium">Consortium</a> </li>{% endif %}
                    <li><a data-toggle="tab" href="#Map">Map</a> </li>
                    {% if queryContext == 'id' %}<li><a data-toggle="tab" href="#Finance">Finance</a> </li>{% endif %}
                </ul>
                <div class="tab-content">
                    <!-- Consortium List group -->
                    {% if queryContext == 'id' %}
                    <div id="Consortium" class="tab-pane fade in active">
                        <br/>
                        <div class="row">
                            {% for o in pro_org %}
                            <div class="col-sm-6 col-md-4">
                                <div class="thumbnail" {% if o.endOfParticipation %} style="background: lightcoral" {% endif %}>
                                    <div class="caption" style="text-align: left;">
                                        <h4>{{ o.organisation__shortName }} {% if o.endOfParticipation %}<span class="badge">Participation Ended</span>{% endif %}</h4>
                                        <h6>{{ o.organisation__name|title }}<br/>{{ o.organisation__street|title }}, {{ o.organisation__city|title }}, {{ o.organisation__postCode }}, {{ o.organisation__country }}</h6>
                                        <strong>NUTS: </strong>{% if o.organisation__regionCode__nutsCode != None %}<a href="?{% url_replace query=o.organisation__regionCode__nutsCode queryContext='region' %}">{{ o.organisation__regionCode__nutsCode }}</a>{% else %}Unknown{% endif %}<br/>
                                        <strong>Role: </strong>{{ o.role|title }}<br/>
                                        <strong>URL: </strong>{% if not o.organisation__organizationUrl|is_nan %}<a href="http://{{ o.organisation__organizationUrl }}" target="_blank">{{ o.organisation__organizationUrl }} <span class="fa fa-external-link"/></a>{% else %}N/A{% endif %}<br/>
                                        <strong>Activity Type: </strong>{{ o.organisation__activityType }}<br/>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <div id="Map" class="tab-pane">
                        <br/>
                        <div id="map" style="height: 400px;width: 100%"></div>
                        <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyDdJDbTCphVAHwZNFQGBtiC1MY4Wma7kTM&region=EU"></script>
                        <script type="text/javascript">
                        $('a[data-toggle="tab"]').on("shown.bs.tab", function(e) {
                            if($(e.target).attr("href") == '#Map')
                                google.maps.event.trigger(document.getElementById("map"), 'resize');
                        });
                        var delay = 100;
                        var infowindow = new google.maps.InfoWindow();
                        var latlng = new google.maps.LatLng(51.454410, -0.904908);
                        var mapOptions = {
                            zoom: 5,
                            center: latlng,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        var geocoder = new google.maps.Geocoder();
                        var map = new google.maps.Map(document.getElementById("map"), mapOptions);
                        var bounds = new google.maps.LatLngBounds();
                        var lineSymbol = {
                            path: 'M 0,-1 0,1',
                            strokeOpacity: 1,
                            scale: 1
                        };
                        function geocodeAddress(address, marker, next) {
                            geocoder.geocode({address:address}, function(results, status) {
                                if(status == google.maps.GeocoderStatus.OK) {
                                    var p = results[0].geometry.location;
                                    createMarker(marker, p.lat(), p.lng());
                                    if(nextAddress == 1) {
                                        latlng = new google.maps.LatLng(p.lat(), p.lng());
                                    } else {
                                        {% if queryContext == 'id' %}
                                        new google.maps.Polyline({
                                            path: [
                                                latlng,
                                                new google.maps.LatLng(p.lat(), p.lng())
                                            ],
                                            strokeColor: '#FF0000',
                                            strokeOpacity: 0.5,
                                            strokeWeight: 0.5,
                                            icons: [{
                                                icon: lineSymbol,
                                                offset: '0',
                                                repeat: '20px'
                                            }],
                                            map: map
                                        });
                                        {% endif %}
                                    }
                                } else {
                                    if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                                        nextAddress--;
                                        delay++;
                                    }
                                }
                                next();
                            }
                        );
                        }
                        function createMarker(add, lat, lng) {
                            var contentString = add;
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(lat, lng),
                                map: map
                            });
                            google.maps.event.addListener(marker, 'click', function() {
                                infowindow.setContent(contentString);
                                infowindow.open(map,marker);
                            });
                            bounds.extend(marker.position);
                        }
                        var markers = [];
                        var locations = [];
                        {% for o in org %}
                            var address = "{{ o.street|title }}, {{ o.city|title }}, {{ o.postCode }}";
                            markers.push("<strong>{{ o.name }}</strong><br/>" + address + ", " + "{{ o.country }}<br/>{{ o.projectAcronym }} Project {{ o.role|title }}<br/> - {{ o.activityType }}");
                            locations.push(address);
                        {% endfor %}

                        var nextAddress = 0;
                        function theNext() {
                            if (nextAddress < locations.length) {
                                setTimeout('geocodeAddress("'+locations[nextAddress]+'", "'+markers[nextAddress]+'", theNext)', delay);
                                nextAddress++;
                            } else {
                                map.fitBounds(bounds);
                                map.zoom = 5;
                            }
                        }
                        theNext();
                        </script>
                        <!-- Map End -->
                    </div>
                    <br/>
                    {% if queryContext == 'id' %}
                    <div id="Finance" class="tab-pane">
                    <h5>Breakdown</h5>
                    <div class="row">
                        <input id="total" type="hidden" value="{{ projects.0.12 }}"/>
                        <input id="max" type="hidden" value="{{ projects.0.13 }}"/>
                        <!-- Pie chart -->
                        <script src="https://code.highcharts.com/highcharts.js"></script>
                        <script src="https://code.highcharts.com/modules/exporting.js"></script>
                        <div id="container" style="width:100%; height:400px; margin:0 auto"></div>
                        <script type="application/javascript">
                            var dict = [];
                            {% for o in pro_org %}
                                var contrib = parseFloat("{{ o.ecContribution }}".replace(',','.'));
                                if(!isNaN(contrib)) {
                                    dict.push({
                                        name: "{{ o.organisation__shortName }}",
                                        val: contrib,
                                        y: contrib / {{ o.project__totalCost }}
                                    });
                                }
                            {% endfor %}
                            Highcharts.chart('container', {
                                chart: {
                                    plotBackgroundColor: null,
                                    plotBorderWidth: null,
                                    plotShadow: false,
                                    type: 'pie'
                                },
                                title: {
                                    text: ''
                                },
                                tooltip: {
                                    pointFormat: '{series.name}: <br/><b>€{point.val:.2f}</b><br/><b>{point.percentage:.1f}%</b>'
                                },
                                plotOptions: {
                                    pie: {
                                        allowPointSelect: true,
                                        cursor: 'pointer',
                                        dataLabels: {
                                            enabled: true,
                                            format: '<b>{point.name}</b>: <br/><b>€{point.val:.2f}</b><br/>{point.percentage:.1f} %',
                                            style: {
                                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                            }
                                        }
                                    }
                                },
                                series: [{
                                    name: 'Contribution',
                                    colorByPoint: true,
                                    data: dict
                                }]
                            }, function(chart) { //on complete
                                chart.renderer.text('Total Cost: €' + {{ pro_org.0.project__totalCost }}, 50, 50).add();
                            });
                        </script>
                        <!-- -->
                    </div>
                    </div>
                    {% endif %}
                    <!-- -->
                </div>
                {% endif %}

                {% if queryContext != 'id' %}
                <!-- Pagination -->
                <nav aria-label="Pager">
                    <ul class="pager">
                        {% if projects.has_previous %}
                            <li class="previous"><a href="?{% url_replace page=projects.previous_page_number %}"><span aria-hidden="true">&larr;</span> Previous</a></li>
                        {% endif %}
                        <span class="current">
                            Page {{ projects.number }} of {{ projects.paginator.num_pages }}.
                        </span>
                        {% if projects.has_next %}
                            <li class="next"><a href="?{% url_replace page=projects.next_page_number %}">Next <span aria-hidden="true">&rarr;</span></a></li>
                        {% endif %}
                    </ul>
                </nav>
                <!-- Pagination End -->
                {% endif %}
            </div>
        </div>
        {% endif %}
	</article>

	<aside id='sidebar'>
        <a href="{% url 'pdf' %}" target="_blank">
		    <button class="alt"> Download Guide  <i class="fa fa-file-pdf-o" aria-hidden="true"></i></button>
        </a>
		<div></div>
        <a href="{% url 'search' %}">
		    <button id="access"> Access to application  <img src="{% static 'img/access-icon.png' %}" width="20"></button>
        </a>
        <div></div>
        <br/>
        {% if query != '' %}
        <!-- Bookmarks bar -->
        <ul id="bookmarks" class="list-group">
            <li class="list-group-item">Bookmarked Projects <span class="fa fa-bookmark"/></li>
        </ul>
        {% endif %}
        <!-- -->
	</aside>

</div>
<!-- Application's space -->
{% endblock %}